---
import BaseLayout from "../layouts/BaseLayout.astro";
import Pagination from "../components/Pagination.astro";

// Get all microblog post files as raw strings
const microPostFiles = import.meta.glob("../posts_micro/*.md", {
    eager: true,
    query: "?raw",
    import: "default",
});

// Process microblog posts manually
const allMicroPosts = Object.entries(microPostFiles)
    .map(([path, rawContent]: [string, string]) => {
        return {
            file: path,
            rawContent: rawContent.trim(),
        };
    })
    .filter((post) => post.rawContent.length > 0)
    .sort((a, b) => {
        const getDateTimeFromPath = (path: string) => {
            // Extract date and time from filename like 2025-12-22-16-51-41
            const match = path.match(
                /(\d{4})-(\d{1,2})-(\d{1,2})-(\d{1,2})-(\d{1,2})-(\d{1,2})/,
            );
            if (match) {
                const [, year, month, day, hour, minute, second] = match;
                const yearPadded = year;
                const monthPadded = month.padStart(2, "0");
                const dayPadded = day.padStart(2, "0");
                const hourPadded = hour.padStart(2, "0");
                const minutePadded = minute.padStart(2, "0");
                const secondPadded = second.padStart(2, "0");
                return `${yearPadded}-${monthPadded}-${dayPadded}T${hourPadded}:${minutePadded}:${secondPadded}`;
            }
            // Fallback to just date
            const dateMatch = path.match(/(\d{4}-\d{1,2}-\d{1,2})/);
            if (dateMatch) {
                const parts = dateMatch[1].split("-");
                const year = parts[0];
                const month = parts[1].padStart(2, "0");
                const day = parts[2].padStart(2, "0");
                return `${year}-${month}-${day}T00:00:00`;
            }
            return "";
        };
        const dateTimeA = getDateTimeFromPath(a.file);
        const dateTimeB = getDateTimeFromPath(b.file);
        // Sort in descending order (newest first)
        return dateTimeB.localeCompare(dateTimeA);
    });

const postsPerPage = 20;
const totalPages = Math.ceil(allMicroPosts.length / postsPerPage);
const currentPage = 1;

// Get only the first page of posts
const paginatedPosts = allMicroPosts.slice(0, postsPerPage);

// Helper functions
function getSlugFromPath(path: string): string {
    return path.split("/").pop()?.replace(".md", "") || "";
}

function getDateTimeFromPath(path: string): string {
    const match = path.match(
        /(\d{4})-(\d{1,2})-(\d{1,2})-(\d{1,2})-(\d{1,2})-(\d{1,2})/,
    );
    if (match) {
        const [, year, month, day, hour, minute, second] = match;
        const yearPadded = year;
        const monthPadded = month.padStart(2, "0");
        const dayPadded = day.padStart(2, "0");
        const hourPadded = hour.padStart(2, "0");
        const minutePadded = minute.padStart(2, "0");
        const secondPadded = second.padStart(2, "0");
        return `${yearPadded}-${monthPadded}-${dayPadded}T${hourPadded}:${minutePadded}:${secondPadded}`;
    }
    const dateMatch = path.match(/(\d{4}-\d{1,2}-\d{1,2})/);
    if (dateMatch) {
        const parts = dateMatch[1].split("-");
        const year = parts[0];
        const month = parts[1].padStart(2, "0");
        const day = parts[2].padStart(2, "0");
        return `${year}-${month}-${day}T00:00:00`;
    }
    return "";
}

function formatMicroblogDate(dateTimeString: string): string {
    const d = new Date(dateTimeString);
    if (isNaN(d.getTime())) return dateTimeString;

    // Date Part: "Dec 22, 2025"
    const datePart = d.toLocaleDateString("en-US", {
        year: "numeric",
        month: "short",
        day: "numeric",
    });

    // Time Part: "16:51" (Manually constructed for 24h)
    const hours = d.getHours().toString().padStart(2, "0");
    const minutes = d.getMinutes().toString().padStart(2, "0");

    return `${datePart}, ${hours}:${minutes}`;
}

function getMicroPostContent(post: any): string {
    try {
        let processedContent = post.rawContent;

        if (processedContent.length === 0) return "";

        processedContent = processedContent.replace(/\{\{site\.url\}\}/g, "");
        processedContent = processedContent.replace(/\{:[^}]+\}/g, "");

        // Convert markdown images
        processedContent = processedContent.replace(
            /!\[([^\]]*)\]\(([^)]+)\)/g,
            '<img src="$2" alt="$1" style="max-width: 100%; height: auto;" class="clickableimg">',
        );

        // Convert tooltip syntax
        processedContent = processedContent.replace(
            /\(\:\:([^)]+)\)/g,
            '<span class="hover-footnote" data-title="$1">*</span>',
        );

        // Convert markdown links
        processedContent = processedContent.replace(
            /\[([^\]]+)\]\(([^)]+)\)/g,
            '<a href="$2">$1</a>',
        );

        // Convert line breaks
        processedContent = processedContent.replace(/\n/g, "<br>");

        return processedContent;
    } catch (error) {
        return "";
    }
}

function generatePageUrl(page: number): string {
    if (page === 1) return "/microblog";
    return `/microblog/${page}`;
}
---

<BaseLayout title="ummshsh microblog">
    <div class="posts-container">
        <div class="posts-list">
            {
                paginatedPosts.map((post) => {
                    const slug = getSlugFromPath(post.file);
                    const dateTime = getDateTimeFromPath(post.file);
                    const content = getMicroPostContent(post);

                    return (
                        <article class="post-item">
                            <header class="post-header">
                                <h2 class="post-title">
                                    <a href={`/microblog/${slug}`}>
                                        {formatMicroblogDate(dateTime)}
                                    </a>
                                </h2>
                            </header>
                            <div class="post-content">
                                <Fragment set:html={content} />
                            </div>
                        </article>
                    );
                })
            }
        </div>

        <Pagination
            currentPage={currentPage}
            totalPages={totalPages}
            generatePageUrl={generatePageUrl}
        />
    </div>
</BaseLayout>

<style>
    /* Styling for content within microblogs */
    .post-content :global(img) {
        margin: 1rem 0;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        max-width: 100%;
        height: auto;
    }

    .post-content :global(iframe) {
        margin: 1rem 0;
        max-width: 100%;
    }

    @media (max-width: 768px) {
        .posts-container {
            padding: 1rem;
        }

        .post-content :global(iframe) {
            width: 100%;
            height: 200px;
        }
    }
</style>
