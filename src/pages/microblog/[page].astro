---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Pagination from "../../components/Pagination.astro";

export async function getStaticPaths() {
    // 1. CHANGE: Look at posts_micro, not posts
    // Also use the specific query parameters for microblogs (?raw)
    const microPostFiles = import.meta.glob("../../posts_micro/*.md", {
        eager: true,
        query: "?raw",
        import: "default",
    });

    // 2. CHANGE: Use the Microblog processing logic (copying from your microblog index)
    const allMicroPosts = Object.entries(microPostFiles)
        .map(([path, rawContent]: [string, any]) => {
            return {
                file: path,
                rawContent: rawContent.trim(),
            };
        })
        .filter((post) => post.rawContent.length > 0)
        .sort((a, b) => {
            // Helper defined inside getStaticPaths for sorting
            const getDateTimeFromPath = (path: string) => {
                const match = path.match(
                    /(\d{4})-(\d{1,2})-(\d{1,2})-(\d{1,2})-(\d{1,2})-(\d{1,2})/,
                );
                if (match) {
                    const [, year, month, day, hour, minute, second] = match;
                    return `${year}-${month.padStart(2, "0")}-${day.padStart(2, "0")}T${hour.padStart(2, "0")}:${minute.padStart(2, "0")}:${second.padStart(2, "0")}`;
                }
                return "";
            };
            const dateTimeA = getDateTimeFromPath(a.file);
            const dateTimeB = getDateTimeFromPath(b.file);
            return dateTimeB.localeCompare(dateTimeA);
        });

    const postsPerPage = 20; // Matches your microblog index settings
    const totalPages = Math.ceil(allMicroPosts.length / postsPerPage);

    // Generate paths for pages 2 and beyond
    return Array.from({ length: totalPages - 1 }, (_, i) => {
        const pageNum = i + 2;
        const startIndex = (pageNum - 1) * postsPerPage;
        const endIndex = startIndex + postsPerPage;
        const paginatedPosts = allMicroPosts.slice(startIndex, endIndex);

        return {
            params: { page: pageNum.toString() },
            props: {
                paginatedPosts,
                currentPage: pageNum,
                totalPages,
            },
        };
    });
}

const { paginatedPosts, currentPage, totalPages } = Astro.props;

// --- HELPER FUNCTIONS (Specific to Microblog) ---

function getSlugFromPath(path: string): string {
    return path.split("/").pop()?.replace(".md", "") || "";
}

function getDateTimeFromPath(path: string): string {
    const match = path.match(
        /(\d{4})-(\d{1,2})-(\d{1,2})-(\d{1,2})-(\d{1,2})-(\d{1,2})/,
    );
    if (match) {
        const [, year, month, day, hour, minute, second] = match;
        return `${year}-${month.padStart(2, "0")}-${day.padStart(2, "0")}T${hour.padStart(2, "0")}:${minute.padStart(2, "0")}:${second.padStart(2, "0")}`;
    }
    return "";
}

function formatMicroblogDate(dateTimeString: string): string {
    const d = new Date(dateTimeString);
    if (isNaN(d.getTime())) return dateTimeString;

    const datePart = d.toLocaleDateString("en-US", {
        year: "numeric",
        month: "short",
        day: "numeric",
    });
    const hours = d.getHours().toString().padStart(2, "0");
    const minutes = d.getMinutes().toString().padStart(2, "0");

    return `${datePart}, ${hours}:${minutes}`;
}

function getMicroPostContent(post: any): string {
    try {
        let processedContent = post.rawContent;
        if (processedContent.length === 0) return "";

        processedContent = processedContent.replace(/\{\{site\.url\}\}/g, "");
        processedContent = processedContent.replace(/\{:[^}]+\}/g, "");
        processedContent = processedContent.replace(
            /!\[([^\]]*)\]\(([^)]+)\)/g,
            '<img src="$2" alt="$1" style="max-width: 100%; height: auto;" class="clickableimg">',
        );
        processedContent = processedContent.replace(
            /\(\:\:([^)]+)\)/g,
            '<span class="hover-footnote" data-title="$1">*</span>',
        );
        processedContent = processedContent.replace(
            /\[([^\]]+)\]\(([^)]+)\)/g,
            '<a href="$2">$1</a>',
        );
        processedContent = processedContent.replace(/\n/g, "<br>");

        return processedContent;
    } catch (error) {
        return "";
    }
}

// 3. CHANGE: Update URL generation to point to microblog
function generatePageUrl(page: number): string {
    if (page === 1) return "/microblog";
    return `/microblog/${page}`;
}
---

<BaseLayout title={`Microblog - Page ${currentPage}`}>
    <div class="posts-container">
        <div class="posts-list">
            {
                paginatedPosts.map((post) => {
                    const slug = getSlugFromPath(post.file);
                    const dateTime = getDateTimeFromPath(post.file);
                    const content = getMicroPostContent(post);

                    return (
                        <article class="post-item">
                            <header class="post-header">
                                <h2 class="post-title">
                                    <a href={`/microblog/${slug}`}>
                                        {formatMicroblogDate(dateTime)}
                                    </a>
                                </h2>
                            </header>
                            <div class="post-content">
                                <Fragment set:html={content} />
                            </div>
                        </article>
                    );
                })
            }
        </div>

        <Pagination
            currentPage={currentPage}
            totalPages={totalPages}
            generatePageUrl={generatePageUrl}
        />
    </div>
</BaseLayout>

<style>
    .post-content :global(img) {
        margin: 1rem 0;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        max-width: 100%;
        height: auto;
    }
    .post-content :global(iframe) {
        margin: 1rem 0;
        max-width: 100%;
    }
    @media (max-width: 768px) {
        .posts-container { padding: 1rem; }
        .post-content :global(iframe) { width: 100%; height: 200px; }
    }
</style>
